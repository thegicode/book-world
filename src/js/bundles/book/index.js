"use strict";(()=>{var E=class{constructor(){this._bus=document.createElement("div")}add(t,e){this._bus.addEventListener(t,e)}remove(t,e){this._bus.removeEventListener(t,e)}dispatch(t,e={}){this._bus.dispatchEvent(new CustomEvent(t,{detail:e}))}},j=new E;var I=function(i,t,e,n){function r(o){return o instanceof e?o:new e(function(a){a(o)})}return new(e||(e=Promise))(function(o,a){function h(s){try{l(n.next(s))}catch(c){a(c)}}function d(s){try{l(n.throw(s))}catch(c){a(c)}}function l(s){s.done?o(s.value):r(s.value).then(h,d)}l((n=n.apply(i,t||[])).next())})},w=class{constructor(t={}){this.defaultOptions=Object.assign({method:"GET",headers:{"Content-Type":"application/json"}},t)}fetch(t,e){return I(this,void 0,void 0,function*(){let n=Object.assign(Object.assign(Object.assign({},this.defaultOptions),e),{timeout:5e3});try{let r=yield fetch(t,n);if(!r.ok)throw new Error(`Http error! status: ${r.status}, message: ${r.statusText}`);return yield r.json()}catch(r){throw console.error(`Error fetching data: ${r}`),new Error(`Error fetching data: ${r}`)}})}},u=new w;var N=i=>JSON.parse(JSON.stringify(i)),B={favoriteBooks:[],libraries:{},regions:{}},q="BookWorld",C=i=>{try{localStorage.setItem(q,JSON.stringify(i))}catch(t){console.error(t)}},f=()=>{try{let i=localStorage.getItem(q);return i==null?(C(B),B):N(JSON.parse(i))}catch(i){throw console.error(i),new Error("Failed to get state from localStrage.")}},m=f(),_=i=>{m.favoriteBooks.push(i),C(m)},T=i=>{let t=m.favoriteBooks.indexOf(i);t!==-1&&(m.favoriteBooks.splice(t,1),C(m))},A=i=>m.favoriteBooks.includes(i);var b=class extends HTMLElement{constructor(){super(),this.favoriteBooksSize=this.getFavoriteBooksSize()}connectedCallback(){this.render(),this.setSelectedMenu()}disconnectedCallback(){}getFavoriteBooksSize(){return f().favoriteBooks.length}render(){this.innerHTML=`
            <nav class="gnb">
                <a class="gnb-item" href="./search">\uCC45 \uAC80\uC0C9</a>
                <a class="gnb-item" href="./favorite">\uB098\uC758 \uCC45 (<span class="size">${this.favoriteBooksSize}</span>)</a>
                <a class="gnb-item" href="./library">\uB3C4\uC11C\uAD00 \uC870\uD68C</a>
                <a class="gnb-item" href="./setting">\uC124\uC815</a>
            </nav>`}setSelectedMenu(){let e=["/search","/favorite","/library","/setting"].indexOf(document.location.pathname);e>=0&&(this.querySelectorAll("a")[e].ariaSelected="true")}};var F=(i=f().favoriteBooks.length)=>{let t=document.querySelector("nav-gnb");t.querySelector(".size").textContent=String(i)};var p=class extends HTMLElement{constructor(){super(),this.inputElement=null,this.isbn=null}connectedCallback(){var t;let e=this.closest("[data-isbn]");this.isbn=e.dataset.isbn,this.render(),(t=this.inputElement)===null||t===void 0||t.addEventListener("change",this.onChange.bind(this))}disconnectedCallback(){var t;(t=this.inputElement)===null||t===void 0||t.addEventListener("change",this.onChange)}render(){let t=this.isbn||"",e=A(t)?"checked":"";this.innerHTML=`<label>
            <input type="checkbox" name="favorite" ${e}>
            <span>\uAD00\uC2EC\uCC45</span>
        </label>`,this.inputElement=this.querySelector("input")}onChange(){var t;let e=this.isbn||"";!((t=this.inputElement)===null||t===void 0)&&t.checked?_(e):T(e),F()}};var v=class extends HTMLElement{constructor(){super()}set data(t){this.dataset.object=JSON.stringify(t);let e=this.querySelector("img");e&&e.getAttribute("src")===""&&this.render()}connectedCallback(){this.render()}render(){let t=this.dataset.object?JSON.parse(this.dataset.object):null,e="",n="";if(t){let{bookImageURL:o,bookname:a}=t;e=o,n=a}this.innerHTML=`
            <div class="book-image">
                <img class="thumb" src="${e}" alt="${n}"></img>
            </div>`;let r=this.querySelector("img");r&&r.getAttribute("src")&&this.handleError(r)}handleError(t){t&&(t.onerror=()=>{this.dataset.fail="true",t.remove()})}};var R=function(i,t,e,n){function r(o){return o instanceof e?o:new e(function(a){a(o)})}return new(e||(e=Promise))(function(o,a){function h(s){try{l(n.next(s))}catch(c){a(c)}}function d(s){try{l(n.throw(s))}catch(c){a(c)}}function l(s){s.done?o(s.value):r(s.value).then(h,d)}l((n=n.apply(i,t||[])).next())})},k=class extends HTMLElement{constructor(){super(),this.loadingElement=this.querySelector(".loading"),this.data=null}connectedCallback(){let t=new URLSearchParams(location.search).get("isbn");this.dataset.isbn=t,this.fetchUsageAnalysisList(t)}fetchUsageAnalysisList(t){return R(this,void 0,void 0,function*(){try{let e=yield u.fetch(`/usage-analysis-list?isbn13=${t}`);this.data=e,this.render()}catch(e){throw this.renderError(),console.error(e),new Error("Fail to get usage analysis list.")}})}render(){if(!this.data)return;let{book:{bookname:t,authors:e,bookImageURL:n,class_nm:r,class_no:o,description:a,isbn13:h,loanCnt:d,publication_year:l,publisher:s},keywords:c,recBooks:y}=this.data,H=t.split(/[=/:]/).map(g=>`<p>${g}</p>`).join(""),$=c.map(g=>`<span>${g.word}</span>`).join(""),O=y.map(({bookname:g,isbn13:M})=>`<li><a href=book?isbn=${M}>${g}</a></li>`).join("");this.querySelector(".bookname").innerHTML=H,this.querySelector(".authors").textContent=e,this.querySelector(".class_nm").textContent=r,this.querySelector(".class_no").textContent=o,this.querySelector(".description").textContent=a,this.querySelector(".isbn13").textContent=h,this.querySelector(".loanCnt").textContent=d.toLocaleString(),this.querySelector(".publication_year").textContent=l,this.querySelector(".publisher").textContent=s,this.querySelector(".keyword").innerHTML=$,this.querySelector(".recBooks").innerHTML=O;let L=this.querySelector("book-image");L&&(L.data={bookImageURL:n,bookname:t}),this.loadingElement.remove()}renderError(){this.loadingElement.textContent="\uC815\uBCF4\uB97C \uAC00\uC838\uC62C \uC218 \uC5C6\uC2B5\uB2C8\uB2E4."}};var x=function(i,t,e,n){function r(o){return o instanceof e?o:new e(function(a){a(o)})}return new(e||(e=Promise))(function(o,a){function h(s){try{l(n.next(s))}catch(c){a(c)}}function d(s){try{l(n.throw(s))}catch(c){a(c)}}function l(s){s.done?o(s.value):r(s.value).then(h,d)}l((n=n.apply(i,t||[])).next())})},S=class extends HTMLElement{constructor(){super()}connectedCallback(){let t=new URLSearchParams(location.search).get("isbn");this.fetchList(t)}fetchList(t){return x(this,void 0,void 0,function*(){let e=f().regions;for(let n in e){let r=Object.values(e[n]);if(r.length===0)return;let o=r[0].slice(0,2);r.forEach(a=>{this.fetchLibrarySearchByBook(t,o,a)})}})}fetchLibrarySearchByBook(t,e,n){return x(this,void 0,void 0,function*(){let o=`/library-search-by-book?${new URLSearchParams({isbn:t,region:e,dtl_region:n})}`;try{let a=yield u.fetch(o);this.render(a,t)}catch(a){throw console.error(a),new Error("Fail to get library search by book.")}})}render({libraries:t},e){if(t.length<1)return;let n=document.querySelector(".library-search-by-book");if(!n)return;let r=document.createElement("ul"),o=new DocumentFragment;t.forEach(({homepage:a,libCode:h,libName:d})=>{var l;let s=document.querySelector("#tp-librarySearchByBookItem");if(!s)return;let c=(l=s.content.firstElementChild)===null||l===void 0?void 0:l.cloneNode(!0),y=c.querySelector("a");y&&(c.dataset.code=h,y.textContent=d,y.href=a,this.loanAvailable(e,h,c.querySelector("p")),o.appendChild(c))}),r.appendChild(o),n.appendChild(r)}loanAvailable(t,e,n){return x(this,void 0,void 0,function*(){let r=yield this.fetchLoadnAvailabilty(t,e),o=n.querySelector(".loanAvailable");o&&(o.textContent=r?"\uB300\uCD9C \uAC00\uB2A5":"\uB300\uCD9C \uBD88\uAC00",r&&n.parentElement&&(n.parentElement.dataset.available="true"))})}fetchLoadnAvailabilty(t,e){return x(this,void 0,void 0,function*(){let r=`/book-exist?${new URLSearchParams({isbn13:t,libCode:e})}`;try{return(yield u.fetch(r,{method:"GET",headers:{"Content-Type":"application/json"}})).loanAvailable==="Y"}catch(o){throw console.error(o),new Error("Fail to get book exist.")}})}};customElements.define("nav-gnb",b);customElements.define("app-book",k);customElements.define("library-search-by-book",S);customElements.define("checkbox-favorite-book",p);customElements.define("book-image",v);})();
