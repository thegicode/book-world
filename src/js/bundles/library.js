"use strict";(()=>{var E=class{constructor(){this._bus=document.createElement("div")}add(e,t){this._bus.addEventListener(e,t)}remove(e,t){this._bus.removeEventListener(e,t)}dispatch(e,t={}){this._bus.dispatchEvent(new CustomEvent(e,{detail:t}))}},m=new E;var q=function(o,e,t,n){function r(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function c(a){try{l(n.next(a))}catch(h){s(h)}}function d(a){try{l(n.throw(a))}catch(h){s(h)}}function l(a){a.done?i(a.value):r(a.value).then(c,d)}l((n=n.apply(o,e||[])).next())})},S=class{constructor(e={}){this.defaultOptions=Object.assign({method:"GET",headers:{"Content-Type":"application/json"}},e)}fetch(e,t){return q(this,void 0,void 0,function*(){let n=Object.assign(Object.assign(Object.assign({},this.defaultOptions),t),{timeout:5e3});try{let r=yield fetch(e,n);if(!r.ok)throw new Error(`Http error! status: ${r.status}, message: ${r.statusText}`);return yield r.json()}catch(r){throw console.error(`Error fetching data: ${r}`),new Error(`Error fetching data: ${r}`)}})}},y=new S;var O=o=>JSON.parse(JSON.stringify(o)),x={favoriteBooks:[],libraries:{},regions:{}},L="BookWorld",C=o=>{try{localStorage.setItem(L,JSON.stringify(o))}catch(e){console.error(e)}},u=()=>{try{let o=localStorage.getItem(L);return o==null?(C(x),x):O(JSON.parse(o))}catch(o){throw console.error(o),new Error("Failed to get state from localStrage.")}},p=u();var w=(o,e)=>{p.libraries[o]=e,C(p)},B=o=>{delete p.libraries[o],C(p)},k=o=>o in p.libraries;var f=class extends HTMLElement{constructor(){super(),this.favoriteBooksSize=this.getFavoriteBooksSize()}connectedCallback(){this.render(),this.setSelectedMenu()}disconnectedCallback(){}getFavoriteBooksSize(){return u().favoriteBooks.length}render(){this.innerHTML=`
            <nav class="gnb">
                <a class="gnb-item" href="./search">\uCC45 \uAC80\uC0C9</a>
                <a class="gnb-item" href="./favorite">\uB098\uC758 \uCC45 (<span class="size">${this.favoriteBooksSize}</span>)</a>
                <a class="gnb-item" href="./library">\uB3C4\uC11C\uAD00 \uC870\uD68C</a>
                <a class="gnb-item" href="./setting">\uC124\uC815</a>
            </nav>`}setSelectedMenu(){let t=["/search","/favorite","/library","/setting"].indexOf(document.location.pathname);t>=0&&(this.querySelectorAll("a")[t].ariaSelected="true")}};var T=function(o,e,t,n){function r(i){return i instanceof t?i:new t(function(s){s(i)})}return new(t||(t=Promise))(function(i,s){function c(a){try{l(n.next(a))}catch(h){s(h)}}function d(a){try{l(n.throw(a))}catch(h){s(h)}}function l(a){a.done?i(a.value):r(a.value).then(c,d)}l((n=n.apply(o,e||[])).next())})},b=class extends HTMLElement{constructor(){super(),this.form=this.querySelector("form")}connectedCallback(){m.add("set-detail-region",this.handleDetailRegion.bind(this))}disconnectedCallback(){m.remove("set-detail-region",this.handleDetailRegion)}fetchLibrarySearch(e){return T(this,void 0,void 0,function*(){try{let t=`/library-search?dtl_region=${e}&page=1&pageSize=20`,n=yield y.fetch(t);this.render(n)}catch(t){throw console.error(t),new Error("Fail to get library search data.")}})}render(e){let{libraries:t}=e;if(t.length===0){this.showMessage("notFound");return}let n=document.querySelector("#tp-item").content.firstElementChild,r=t.reduce((i,s)=>{if(n){let c=n.cloneNode(!0);c.dataset.object=JSON.stringify(s),k(s.libCode)?(c.dataset.has="true",i.insertBefore(c,i.firstChild)):i.appendChild(c)}return i},new DocumentFragment);this.form.innerHTML="",this.form.appendChild(r)}showMessage(e){let t=document.querySelector(`#tp-${e}`).content.firstElementChild;if(t){let n=t.cloneNode(!0);this.form.innerHTML="",this.form.appendChild(n)}}handleDetailRegion(e){this.showMessage("loading"),this.fetchLibrarySearch(e.detail.detailRegionCode)}};var g=class extends HTMLElement{constructor(){super(),this.selectElement=this.querySelector("select")}connectedCallback(){this.renderRegion(),this.selectElement.addEventListener("change",this.onChangeDetail.bind(this))}disconnectedCallback(){this.selectElement.removeEventListener("change",this.onChangeDetail)}renderRegion(){let e=u().regions;if(Object.values(e).length<1)return;let t=document.querySelector("#tp-region").content.firstElementChild,n=this.querySelector(".region"),r=new DocumentFragment;for(let s of Object.keys(e)){let c=Object.keys(e[s]).length;if(t&&c>0){let d=t.cloneNode(!0),l=d.querySelector("input");l&&(l.value=s);let a=d.querySelector("span");a&&(a.textContent=s),r.appendChild(d)}}n.appendChild(r);let i=n.querySelector("input");i.checked=!0,this.renderDetailRegion(i.value),this.changeRegion()}changeRegion(){this.querySelectorAll("[name=region]").forEach(t=>{t.addEventListener("change",()=>{if(t.checked){let n=t.value;this.renderDetailRegion(n)}})})}renderDetailRegion(e){this.selectElement.innerHTML="";let t=u().regions[e];for(let[r,i]of Object.entries(t)){let s=document.createElement("option");s.textContent=r,s.value=i,this.selectElement.appendChild(s)}let n=this.selectElement.querySelector("option");n.selected=!0,this.onChangeDetail()}onChangeDetail(){let{value:e}=this.selectElement;m.dispatch("set-detail-region",{detailRegionCode:e})}};var v=class extends HTMLElement{constructor(){super(),this.checkbox=null,this.libCode="",this.libName="",this.checkbox=this.querySelector("[name=myLibrary]")}connectedCallback(){var e;this.render(),(e=this.checkbox)===null||e===void 0||e.addEventListener("click",this.onChange.bind(this))}disconnectedCallback(){var e;(e=this.checkbox)===null||e===void 0||e.removeEventListener("click",this.onChange)}render(){let e=JSON.parse(this.dataset.object||""),{libCode:t,libName:n}=e;Object.entries(e).forEach(([i,s])=>{let c=this.querySelector(`.${i}`);c&&(c.innerHTML=s)});let r=this.querySelector(".homepage");r&&(r.href=e.homepage),this.libCode=t,this.libName=n,this.checkbox&&(this.checkbox.checked=k(this.libCode))}onChange(e){e.target.checked?w(this.libCode,this.libName):B(this.libCode)}};customElements.define("nav-gnb",f);customElements.define("app-library",b);customElements.define("library-region",g);customElements.define("library-item",v);})();
